<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unir PDFs</title>
    <style>
        #pdfList {
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: white;
            color: #333;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
        }
        #pdfListQR {
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: white;
            color: #333;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
        }
        input[type="file"] {
            display: block;
            margin-bottom: 10px;
            width: 500px; /* Ancho ajustado */
            height: 90px; /* Altura ajustada */
            border: 2px solid #ccc; /* Añadir borde */
            border-radius: 5px; /* Añadir bordes redondeados */
            padding: 4px; /* Espacio interno del borde */
        }

        button {
            display: block;
            margin-bottom: 10px;
            padding: 10px 20px; /* Ajusta el espaciado interno del botón */
            font-size: 16px; /* Tamaño de fuente del botón */
            border: 2px solid #007bff; /* Añadir borde */
            border-radius: 5px; /* Añadir bordes redondeados */
            background-color: #007bff; /* Color de fondo del botón */
            color: white; /* Color del texto */
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.worker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/2.14.0/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
</head>
<body>

<!-- Primera sección: Merge PDFs con Sello y Código QR -->
<section>
    <h2>FOLIOS</h2>
    <form id="pdfForm">
        <label for="pdfInput">Seleccionar PDF:</label>
        <input type="file" id="pdfInput" accept=".pdf" required>
        <br>
        <label for="pdfList">Seleccionar otro PDF:</label>
        <select id="pdfList" required>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/AGUASCALIENTE.PDF">AGUASCALIENTE</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/BAJA%20CALIFORNIA%20SUR.pdf">BAJA CALIFORNIA SUR</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/BAJA%20CALIFORNIA.pdf">BAJA CALIFORNIA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/CAMPECHE.pdf">CAMPECHE</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/CHIAPAS.pdf">CHIAPAS</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/CHIUAHUA.pdf">CHIUAHUA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/CIUDAD%20DE%20MEXICO.pdf">CIUDAD DE MEXICO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/COAHUILA.pdf">COAHUILA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/COLIMA.pdf">COLIMA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/DISTRITO%20FEDERAL.pdf">DISTRITO FEDERAL</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/DURANGO.pdf">DURANGO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/EXTRANJERO.pdf">EXTRANJERO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/GUANAJUATO.pdf">GUANAJUATO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/GUERRERO.pdf">GUERRERO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/HIDALGO.pdf">HIDALGO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/JALISCO.pdf">JALISCO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/MEXICO.pdf">MEXICO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/MICHOACAN.pdf">MICHOACAN DE OCAMPO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/MORELOS.pdf">MORELOS</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/NAYARIT.pdf">NAYARIT</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/NUEVO%20LEON.pdf">NUEVO LEON</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/OAXACA.pdf">OAXACA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/PUEBLA.pdf">PUEBLA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/QUERETARO.pdf">QUERETARO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/QUINTANA%20ROO.pdf">QUINTANA ROO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/SAN%20LUIS%20POTOSI.pdf">SAN LUIS POTOSI</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/SINALOA.pdf">SINALOA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/SONORA.pdf">SONORA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/TABASCO.pdf">TABASCO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/TAMAULIPAS.pdf">TAMAULIPAS</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/TLAXCALA.pdf">TLAXCALA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/VERACRUZ.pdf">VERACRUZ</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/YUCATAN.pdf">YUCATAN</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/ZACATECAS.pdf">ZACATECAS</option>
        </select>
        <br>
        <button type="button" id="mergeButton">Unir PDFs</button>
    </form>
</section>

<div style="height: 50px;"></div> <!-- Ajusta la altura según sea necesario -->

<!-- Segunda sección: Merge PDFs con Código QR -->
<section>
    <h2>UNIONES</h2>
    <form id="pdfFormQR">
        <label for="pdfInputQR">Seleccionar PDF:</label>
        <input type="file" id="pdfInputQR" accept=".pdf" required>
        <br>
        <label for="pdfListQR">Seleccionar otro PDF:</label>
        <select id="pdfListQR" required>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/AGUASCALIENTE.PDF">AGUASCALIENTE</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/BAJA%20CALIFORNIA%20SUR.pdf">BAJA CALIFORNIA SUR</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/BAJA%20CALIFORNIA.pdf">BAJA CALIFORNIA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/CAMPECHE.pdf">CAMPECHE</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/CHIAPAS.pdf">CHIAPAS</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/CHIUAHUA.pdf">CHIUAHUA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/CIUDAD%20DE%20MEXICO.pdf">CIUDAD DE MEXICO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/COAHUILA.pdf">COAHUILA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/COLIMA.pdf">COLIMA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/DISTRITO%20FEDERAL.pdf">DISTRITO FEDERAL</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/DURANGO.pdf">DURANGO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/EXTRANJERO.pdf">EXTRANJERO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/GUANAJUATO.pdf">GUANAJUATO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/GUERRERO.pdf">GUERRERO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/HIDALGO.pdf">HIDALGO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/JALISCO.pdf">JALISCO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/MEXICO.pdf">MEXICO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/MICHOACAN.pdf">MICHOACAN DE OCAMPO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/MORELOS.pdf">MORELOS</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/NAYARIT.pdf">NAYARIT</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/NUEVO%20LEON.pdf">NUEVO LEON</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/OAXACA.pdf">OAXACA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/PUEBLA.pdf">PUEBLA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/QUERETARO.pdf">QUERETARO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/QUINTANA%20ROO.pdf">QUINTANA ROO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/SAN%20LUIS%20POTOSI.pdf">SAN LUIS POTOSI</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/SINALOA.pdf">SINALOA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/SONORA.pdf">SONORA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/TABASCO.pdf">TABASCO</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/TAMAULIPAS.pdf">TAMAULIPAS</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/TLAXCALA.pdf">TLAXCALA</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/VERACRUZ.pdf">VERACRUZ</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/YUCATAN.pdf">YUCATAN</option>
            <option value="https://raw.githubusercontent.com/Maskorss/prueba.github.io/56c9b46fc69d29196c906b3e576512db37279b21/REVERSO/ZACATECAS.pdf">ZACATECAS</option>
        </select>
        <br>
        <button type="button" id="mergeButtonQR">Unir PDFs</button>
    </form>
</section>


 <iframe id="previewFrame" style="display: none; width: 750px; height: 1250px; border: 1px solid #ccc; position: absolute; top: 0px; left: 520px;"></iframe>




    <script>
        async function mergePDFs(pdfBytes1, pdfBytes2) {
            const pdfDoc1 = await PDFLib.PDFDocument.load(pdfBytes1);
            const pdfDoc2 = await PDFLib.PDFDocument.load(pdfBytes2);

            const [pdf1Page] = await pdfDoc1.copyPages(pdfDoc2, [0]);
            pdfDoc1.addPage(pdf1Page);

            return pdfDoc1;
        }

        document.getElementById('mergeButton').addEventListener('click', async () => {
            const pdfInput = document.getElementById('pdfInput');
            const pdfList = document.getElementById('pdfList');
            const resultFrame = document.getElementById('resultFrame');

            const selectedPdf = pdfList.value;
            const uploadedPdf = pdfInput.files[0];

            if (selectedPdf && uploadedPdf) {
                const uploadedPdfData = new Uint8Array(await uploadedPdf.arrayBuffer());

                const response = await fetch(selectedPdf);
                const selectedPdfData = new Uint8Array(await response.arrayBuffer());

                const mergedPdf = await mergePDFs(uploadedPdfData, selectedPdfData);

                // Aplicar el sello y obtener los bytes del PDF resultante
                const [page] = mergedPdf.getPages();
                const randomNumber1 = generateRandomNumber(10, 99);
                const randomNumber2 = generateRandomNumber(1000000, 9999999);
                const fixedText = 'FOLIO';
                const variableText = `A${randomNumber1} ${randomNumber2}`;
                const font = await mergedPdf.embedFont(PDFLib.StandardFonts.Helvetica);

                const topY = page.getHeight() - 50;

                page.drawText(fixedText, {
                    x: 85,
                    y: topY,
                    size: 10,
                    font: await mergedPdf.embedFont(PDFLib.StandardFonts.HelveticaBold),
                    color: PDFLib.rgb(255/255, 90/255, 70/255),
                });

                page.drawText(variableText, {
                    x: 70,
                    y: topY - 10,
                    size: 10,
                    font: await mergedPdf.embedFont(PDFLib.StandardFonts.HelveticaBold),
                    color: PDFLib.rgb(255/255, 90/255, 70/255),
                });

                const barcodeText = `A${randomNumber1}${randomNumber2}`;
                const barcodeCanvas = document.createElement('canvas');
                JsBarcode(barcodeCanvas, barcodeText, {
                    format: 'CODE128',
                    displayValue: false,
                    height: 25,
                    background: 'transparent',
                    lineColor: '#FF5A46',
                    dpi: 300,
                });

                const barcodeImage = await mergedPdf.embedPng(barcodeCanvas.toDataURL('image/png'));
                const [barcodeWidth, barcodeHeight] = [barcodeImage.width, barcodeImage.height];

                const bottomY = 50;

                page.drawImage(barcodeImage, {
                    x: 40,
                    y: topY - 30,
                    width: barcodeWidth * 0.5,
                    height: barcodeHeight * 0.5,
                });

                // Obtener el nombre del archivo del primer PDF sin la extensión .pdf
                const uploadedPdfName = uploadedPdf.name.replace('.pdf', '');

                // Agregar un código QR a la segunda página
                const qrText = uploadedPdfName;
                const qrTextUpperCase = qrText.toUpperCase();
                const qrCanvas = document.createElement('canvas');
                new QRious({
                    element: qrCanvas,
                    value: qrTextUpperCase,
                    size: 100,
                    backgroundAlpha: 0, // Establecer el fondo como transparente
                });

                const qrImage = await mergedPdf.embedPng(qrCanvas.toDataURL('image/png'));

                const secondPage = mergedPdf.getPages()[1]; // Obtener la segunda página
                secondPage.drawImage(qrImage, {
                    x: 30,
                    y: secondPage.getHeight() - 90,
                    width: 62,
                    height: 62,
                });
                
                // Agregar el mismo texto debajo del código QR
                const textSize = 5; // Tamaño del texto
                const text = qrText.toUpperCase(); // Usar el mismo texto del código QR

                // Verificar si el texto cumple con el patrón deseado
                const pattern = /^[A-Z]{4}\d{6}[A-Z]{6}[A-Z0-9]\d$/;
                if (pattern.test(text)) {
                    secondPage.drawText(text, {
                        x: 31,
                        y: secondPage.getHeight() - 97, // Ajusta la posición vertical según sea necesario
                        size: textSize,
                        font: await mergedPdf.embedFont(PDFLib.StandardFonts.Helvetica),
                        color: PDFLib.rgb(0, 0, 0),
                    });
                } else {
                    console.warn('El texto no cumple con el patrón deseado y no se agregará al PDF.');
                }    

                const mergedPdfBytes = await mergedPdf.save();

                // Crear enlace para descargar el PDF con nombre personalizado
                const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);

                const nombreArchivo = uploadedPdf.name.split('.pdf')[0] + '_FOLIO.pdf';

                const descargar = document.createElement('a');
                descargar.href = url;
                descargar.download = nombreArchivo;
                descargar.textContent = 'Descargar PDF Unido con Sello y Código QR';
                descargar.style.display = 'none'; // Ocultar el enlace
                document.body.appendChild(descargar);

                // Simular el clic en el enlace para iniciar la descarga automáticamente
                descargar.click();

                // Mostrar la previsualización del archivo descargado en el iframe
                const previewFrame = document.getElementById('previewFrame');
                previewFrame.src = url;
                previewFrame.style.display = 'block';

                // Eliminar el enlace después de la descarga
                URL.revokeObjectURL(url);
                document.body.removeChild(descargar);
            } else {
                console.error('Seleccione un PDF y suba otro para unir.');
            }
        });

        function generateRandomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
    </script>
    <script>
        async function mergePDFs(pdfBytes1, pdfBytes2) {
            const pdfDoc1 = await PDFLib.PDFDocument.load(pdfBytes1);
            const pdfDoc2 = await PDFLib.PDFDocument.load(pdfBytes2);
    
            const [pdf1Page] = await pdfDoc1.copyPages(pdfDoc2, [0]);
            pdfDoc1.addPage(pdf1Page);
    
            return pdfDoc1;
        }
    
        document.getElementById('mergeButtonQR').addEventListener('click', async () => {
            const pdfInputQR = document.getElementById('pdfInputQR');
            const pdfListQR = document.getElementById('pdfListQR');
            const resultFrameQR = document.getElementById('resultFrameQR');
    
            const selectedPdfQR = pdfListQR.value;
            const uploadedPdfQR = pdfInputQR.files[0];
    
            if (selectedPdfQR && uploadedPdfQR) {
                const uploadedPdfDataQR = new Uint8Array(await uploadedPdfQR.arrayBuffer());
    
                const responseQR = await fetch(selectedPdfQR);
                const selectedPdfDataQR = new Uint8Array(await responseQR.arrayBuffer());
    
                const mergedPdfQR = await mergePDFs(uploadedPdfDataQR, selectedPdfDataQR);
    
                // Agregar un código QR a la segunda página
                const uploadedPdfQRName = uploadedPdfQR.name.replace('.pdf', '');
                const qrText = uploadedPdfQRName.toUpperCase();
                const qrCanvas = document.createElement('canvas');
                new QRious({
                    element: qrCanvas,
                    value: qrText,
                    size: 100,
                    backgroundAlpha: 0, // Establecer el fondo como transparente
                });
    
                const qrImage = await mergedPdfQR.embedPng(qrCanvas.toDataURL('image/png'));
    
                const secondPageQR = mergedPdfQR.getPages()[1]; // Obtener la segunda página
                secondPageQR.drawImage(qrImage, {
                    x: 30,
                    y: secondPageQR.getHeight() - 90,
                    width: 62,
                    height: 62,
                });
    
                // Agregar el mismo texto debajo del código QR
                const textSizeQR = 5; // Tamaño del texto
                const textQR = qrText.toUpperCase(); // Usar el mismo texto del código QR

                // Verificar si el texto cumple con el patrón deseado
                const pattern = /^[A-Z]{4}\d{6}[A-Z]{6}[A-Z0-9]\d$/;
                if (pattern.test(textQR)) {
                    secondPageQR.drawText(textQR, {
                        x: 31,
                        y: secondPageQR.getHeight() - 97, // Ajusta la posición vertical según sea necesario
                        size: textSizeQR,
                        font: await mergedPdfQR.embedFont(PDFLib.StandardFonts.Helvetica),
                        color: PDFLib.rgb(0, 0, 0),
                    });
                } else {
                    console.warn('El texto no cumple con el patrón deseado y no se agregará al PDF.');
                }    

                const mergedPdfBytesQR = await mergedPdfQR.save();
    
                // Crear enlace para descargar el PDF con código QR
                const blobQR = new Blob([mergedPdfBytesQR], { type: 'application/pdf' });
                const urlQR = URL.createObjectURL(blobQR);
    
                const nombreArchivoQR = uploadedPdfQR.name.split('.pdf')[0] + '_DOBLE.pdf';
    
                const descargarQR = document.createElement('a');
                descargarQR.href = urlQR;
                descargarQR.download = nombreArchivoQR;
                descargarQR.textContent = 'Descargar PDF con Código QR';
                descargarQR.style.display = 'none'; // Ocultar el enlace
                document.body.appendChild(descargarQR);

                // Simular el clic en el enlace para iniciar la descarga automáticamente
                descargarQR.click();

                // Mostrar la previsualización del archivo descargado en el iframe
                const previewFrame = document.getElementById('previewFrame');
                previewFrame.src = urlQR;
                previewFrame.style.display = 'block';

                // Eliminar el enlace después de la descarga
                URL.revokeObjectURL(urlQR);
                document.body.removeChild(descargarQR);
            } else {
                console.error('Seleccione un PDF y suba otro para unir.');
            }
        });
    </script>    
</body>
</html>
